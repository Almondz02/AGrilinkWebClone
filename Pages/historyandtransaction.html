<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction History - AgriLink</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/historyandtransaction.css" />
</head>
<body>
  <!-- HEADER -->
  <div class="header-container">
    <div class="header-left">
      <div class="logo">AgriLink</div>
      <div class="search-container">
        <span class="material-symbols-outlined">search</span>
        <input type="text" placeholder="Search Agri" />
      </div>
    </div>
    <div class="header-center">
      <div class="nav-icons">
        <a href="homemain.html" class="icon"><span class="material-symbols-outlined">home</span></a>
        <a href="listing.html" class="icon"><span class="material-symbols-outlined">storefront</span></a>
        <div class="icon" id="chat-icon"><span class="material-symbols-outlined">forum</span></div>
        <div class="icon" id="notification-icon"><span class="material-symbols-outlined">notifications</span></div>
      </div>
    </div>
    <div class="header-right"></div>
  </div>

  <!-- PROFILE SIDEBAR (aligned with homemain.html) -->
  <div class="profile-container">
    <div class="profile-header">
      <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0ec0940b-23d9-4b1f-8e72-2a8bd35584e4.png" alt="Farmer" class="profile-pic" id="profile-link" />
      <div class="profile-name">Juan Dela Cruz</div>
    </div>
    <ul class="profile-menu">
      <li data-href="request.html"><i class="material-symbols-outlined">request_quote</i><span>Request</span></li>
      <li data-href="historyandtransaction.html"><i class="material-symbols-outlined">receipt_long</i><span>History and Transactions</span></li>
      <li data-href="settings.html"><i class="material-symbols-outlined">privacy_tip</i><span>Settings and Privacy</span></li>
      <li data-href="report.html"><i class="material-symbols-outlined">analytics</i><span>Reports</span></li>
    </ul>
    <button class="logout-btn" id="logout-btn"><i class="material-symbols-outlined">logout</i><span>Logout</span></button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-container">
    <div class="main-content">
      <!-- Filters -->
      <div class="filter-controls">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">All Transactions</label>
            <select id="filter-type" class="filter-select">
              <option value="all">All Transactions</option>
              <option value="sales">Sales</option>
              <option value="purchases">Purchases</option>
              <option value="exchanges">Exchanges</option>
              <option value="deliveries">Deliveries</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Filter by Status</label>
            <select id="filter-status" class="filter-select">
              <option value="all">All Status</option>
              <option value="completed">Completed</option>
              <option value="pending">Pending</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Date Range - From</label>
            <input id="date-from" type="date" class="date-input" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Date Range - To</label>
            <input id="date-to" type="date" class="date-input" />
          </div>
        </div>
      </div>

      <!-- Page header -->
      <div class="page-header">
        <h1 class="page-title">Transaction History</h1>
        <p class="page-subtitle">Track all your agricultural waste exchange activities</p>
      </div>

      <!-- Stats grid -->
      <div class="stats-grid">
        <div class="stat-card"><div id="stat-total" class="stat-value">0</div><div class="stat-label">Total Transactions</div></div>
        <div class="stat-card"><div id="stat-earned" class="stat-value">â‚±0</div><div class="stat-label">Total Earnings</div></div>
        <div class="stat-card"><div id="stat-spent" class="stat-value">â‚±0</div><div class="stat-label">Total Spent</div></div>
        <div class="stat-card"><div id="stat-success" class="stat-value">0%</div><div class="stat-label">Success Rate</div></div>
      </div>

      <!-- Transaction list -->
      <div class="transaction-list">
        <div class="list-header">
          <h3 class="list-title">Recent Transactions</h3>
          <div class="list-actions">
            <button class="action-button" id="btn-export"><span class="material-symbols-outlined" style="font-size:16px">download</span>&nbsp;Export</button>
            <button class="action-button" id="btn-sort"><span class="material-symbols-outlined" style="font-size:16px">filter_list</span>&nbsp;Sort</button>
          </div>
        </div>
        <div id="transactions-container"></div>
        <div id="transactions-empty" class="empty-state" style="display:none">
          <span class="material-symbols-outlined">search_off</span>
          <h3>No transactions found</h3>
          <p>Try adjusting your filters to see more results.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification popup (aligned with homemain.html) -->
  <div class="notification-container" id="notification-container" style="position:fixed; top:0; right:0">
    <div class="notification-header"><h3>Notifications</h3><i class="material-symbols-outlined" id="close-notification">close</i></div>
    <div class="notification-list">
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Maria Santos</strong> commented on your post: "This looks great! Would love to buy some."</div><div class="notification-time">2 hrs ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Pedro Bautista</strong> liked your post about organic fertilizer.</div><div class="notification-time">5 hrs ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>AgriTech PH</strong> shared a new article: "Benefits of Organic Waste in Farming"</div><div class="notification-time">1 day ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Farmers Cooperative</strong> added a new listing for compost materials.</div><div class="notification-time">2 days ago</div></div></div>
    </div>
  </div>

  <!-- Chat popup (aligned with homemain.html) -->
  <div class="header-chat-container" id="header-chat-container" style="position:fixed; top:0; right:0">
    <div class="chat-header-popup"><h3>Chats</h3><i class="material-symbols-outlined" id="close-chat">close</i></div>
    <div class="active-users-popup">
      <div class="active-title-popup">Active Now</div>
      <div class="active-list-popup" id="active-users"></div>
    </div>
    <div class="conversations-title-popup">Conversations</div>
    <div class="chat-list-popup" id="chat-list-popup"></div>
  </div>

  <!-- Listings sidebar -->
  <div class="listings-container">
    <div class="listings-header"><h3>Current Listings</h3></div>
    <div class="listings-list" id="listings-list"></div>
  </div>

  <!-- Floating chat windows container (rendered by JS) -->
  <div id="floating-chats-root"></div>

  <script>
  // Minimal script to render some demo transactions and wire basic controls
  (function(){
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

    // Demo transactions data
    const transactions = [
      { id: 1, type: 'sale', status: 'completed', date: '2024-10-01', title: 'Sold 50kg Manure', amount: 2500 },
      { id: 2, type: 'purchase', status: 'pending', date: '2024-10-03', title: 'Bought 30kg Compost', amount: 1800 },
      { id: 3, type: 'delivery', status: 'completed', date: '2024-10-05', title: 'Delivered to Barangay 5', amount: 0 },
    ];

    function peso(n){ return 'â‚±' + Number(n||0).toLocaleString(undefined, { minimumFractionDigits: 0 }); }

    function renderStats(list){
      const total = list.length;
      const earned = list.filter(t=>t.type==='sale').reduce((s,t)=> s + (t.amount||0), 0);
      const spent = list.filter(t=>t.type==='purchase').reduce((s,t)=> s + (t.amount||0), 0);
      const successRate = total ? Math.round((list.filter(t=>t.status==='completed').length / total) * 100) : 0;
      const byId = id => document.getElementById(id);
      const W = (id, val) => { const el = byId(id); if(el) el.textContent = val; };
      W('stat-total', String(total));
      W('stat-earned', peso(earned));
      W('stat-spent', peso(spent));
      W('stat-success', successRate + '%');
    }

    function renderTransactions(list){
      const root = $('#transactions-container');
      const empty = $('#transactions-empty');
      if(!root || !empty) return;
      if(list.length === 0){ root.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';
      root.innerHTML = list.map(t => `
        <div class="transaction-item" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eef2f7;">
          <div>
            <div style="font-weight:700;">${t.title}</div>
            <div style="font-size:12px; color:#64748b;">${t.date} â€¢ ${t.type} â€¢ ${t.status}</div>
          </div>
          <div style="font-weight:700; color:#047857;">${t.amount? peso(t.amount): ''}</div>
        </div>
      `).join('');
    }

    function applyFilters(){
      const type = $('#filter-type')?.value || 'all';
      const status = $('#filter-status')?.value || 'all';
      const from = $('#date-from')?.value;
      const to = $('#date-to')?.value;
      let list = [...transactions];
      if(type !== 'all') list = list.filter(t => ({sales:'sale', purchases:'purchase', exchanges:'exchange', deliveries:'delivery'}[type]) ? t.type === ({sales:'sale', purchases:'purchase', exchanges:'exchange', deliveries:'delivery'}[type]) : true);
      if(status !== 'all') list = list.filter(t => t.status === status);
      if(from) list = list.filter(t => t.date >= from);
      if(to) list = list.filter(t => t.date <= to);
      renderStats(list);
      renderTransactions(list);
    }

    // Wire controls
    ['filter-type','filter-status','date-from','date-to'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener('change', applyFilters);
    });

    // Populate right sidebar listings placeholder
    (function renderListings(){
      const el = document.getElementById('listings-list');
      if(!el) return;
      const samples = [
        { title: 'Cattle Manure', detail: 'â‚±50.00 â€¢ 500kg' },
        { title: 'Organic Compost', detail: 'â‚±75.00 â€¢ 300kg' },
        { title: 'Goat Manure', detail: 'â‚±60.00 â€¢ 200kg' },
      ];
      el.innerHTML = samples.map(s => `
        <div style="border:1px solid #e5e7eb; border-radius:10px; padding:10px;">
          <div style="font-weight:700;">${s.title}</div>
          <div style="font-size:12px; color:#64748b;">${s.detail}</div>
        </div>
      `).join('');
    })();

    // Initial render
    applyFilters();

    // ===== Header Notifications (aligned with homemain.html) =====
    const notificationIcon = $('#notification-icon');
    const notificationContainer = $('#notification-container');
    const closeNotif = $('#close-notification');
    if (notificationIcon && notificationContainer) {
      notificationIcon.addEventListener('click', (e) => {
        const rect = notificationIcon.getBoundingClientRect();
        notificationContainer.style.top = (rect.bottom + 5) + 'px';
        notificationContainer.style.right = (window.innerWidth - rect.right - 190) + 'px';
        notificationContainer.classList.toggle('visible');
        e.stopPropagation();
      });
      document.addEventListener('click', (e) => {
        if (notificationContainer.classList.contains('visible') && !notificationContainer.contains(e.target) && e.target !== notificationIcon) {
          notificationContainer.classList.remove('visible');
        }
      });
      if (closeNotif) closeNotif.addEventListener('click', () => notificationContainer.classList.remove('visible'));
    }

    // ===== Header Chat (aligned with homemain.html) =====
    const chatIcon = $('#chat-icon');
    const chatContainer = $('#header-chat-container');
    const closeChat = $('#close-chat');

    const initialConversations = [
      { id: 'mang-jose', name: 'Mang Jose', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/70ed3f6c-a0ca-4490-8b6a-eaa245dffa33.png', lastMessage: 'Hi, about the manure delivery tomorrow...', time: '2:30 PM', messages: [ { id: 1, text: 'Hi, about the manure delivery tomorrow...', sender: 'them', time: '2:30 PM' }, { id: 2, text: 'What time should I expect the delivery?', sender: 'them', time: '2:31 PM' } ] },
      { id: 'farmers-coop', name: 'Farmers Cooperative', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/250bc031-e5eb-4467-9d71-49154b992c13.png', lastMessage: 'New bulk order of organic fertilizer available', time: 'Yesterday', messages: [ { id: 1, text: 'New bulk order of organic fertilizer available', sender: 'them', time: 'Yesterday' }, { id: 2, text: 'Would you be interested in placing an order?', sender: 'them', time: 'Yesterday' } ] }
    ];

    const chatState = {
      conversations: [...initialConversations],
      openChatWindows: [],
      typingUsers: {},
      messageInputs: {},
    };

    function renderActiveUsers(){
      const host = $('#active-users');
      if(!host) return;
      const users = [
        { id:'ana-gonzales', name:'Ana Gonzales', avatar:'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ee4b5487-b1ea-40b6-9a76-0415e304de49.png' },
        { id:'carlos-reyes', name:'Carlos Reyes', avatar:'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/331059ac-f6bf-4684-b902-d37824bad8f5.png' },
        { id:'lorna-lim', name:'Lorna Lim', avatar:'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/2ab478de-5d6d-4dce-8c67-baf47fd7ad8e.png' },
      ];
      host.innerHTML = users.map(u => `
        <div class="active-user-popup" data-user='${JSON.stringify(u)}'>
          <div class="user-status-popup">
            <img src="${u.avatar}" alt="${u.name}" />
            <span class="status-indicator-popup"></span>
          </div>
          <span class="name-popup">${u.name.split(' ')[0]}</span>
        </div>
      `).join('');
      $$('.active-user-popup', host).forEach(el => {
        el.addEventListener('click', () => {
          const user = JSON.parse(el.getAttribute('data-user'));
          openChatWindow({ ...user, messages: [] });
          if (chatContainer) chatContainer.classList.remove('visible');
        });
      });
    }

    function renderChatList(){
      const list = $('#chat-list-popup');
      if(!list) return;
      list.innerHTML = '';
      chatState.conversations.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat-item-popup';
        item.innerHTML = `
          <img src="${c.avatar}" alt="${c.name}" />
          <div class="chat-info-popup">
            <div class="chat-name-popup">${c.name}</div>
            <div class="chat-preview-popup">${c.lastMessage}</div>
          </div>
          <div class="chat-time-popup">${c.time}</div>
        `;
        item.addEventListener('click', () => openChatWindow(c));
        list.appendChild(item);
      });
    }

    function openChatWindow(user){
      if (chatState.openChatWindows.find(c => c.id === user.id)) return;
      const existing = chatState.conversations.find(c => c.id === user.id);
      const newChat = { id:user.id, name:user.name, avatar:user.avatar, messages: existing?.messages || user.messages || [], isMinimized:false };
      if (!existing) {
        chatState.conversations = [ { id:user.id, name:user.name, avatar:user.avatar, lastMessage:'Start a conversation...', time:'Now', messages:[] }, ...chatState.conversations ];
        renderChatList();
      }
      chatState.openChatWindows.push(newChat);
      renderFloatingChats();
    }

    function closeChatWindow(chatId){
      chatState.openChatWindows = chatState.openChatWindows.filter(c => c.id !== chatId);
      renderFloatingChats();
    }
    function minimizeChatWindow(chatId){
      chatState.openChatWindows = chatState.openChatWindows.map(c => c.id === chatId ? { ...c, isMinimized: !c.isMinimized } : c);
      renderFloatingChats();
    }
    function autoScrollMessages(chatId){
      const el = document.getElementById(`messages-${chatId}`);
      if (el) el.scrollTop = el.scrollHeight;
    }
    function sendMessage(chatId, message){
      if(!message || !message.trim()) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const m = { id: Date.now(), text: message, sender:'me', time, timestamp:new Date(), status:'sent' };
      chatState.openChatWindows = chatState.openChatWindows.map(c => c.id === chatId ? { ...c, messages:[...c.messages, m] } : c);
      chatState.conversations = chatState.conversations.map(conv => conv.id === chatId ? { ...conv, lastMessage: message, time:'Now', messages:[...conv.messages, m] } : conv);
      chatState.messageInputs[chatId] = '';
      renderFloatingChats();
      simulateTypingAndResponse(chatId);
      setTimeout(() => autoScrollMessages(chatId), 100);
    }
    function simulateTypingAndResponse(chatId){
      chatState.typingUsers[chatId] = true;
      renderFloatingChats();
      setTimeout(() => {
        chatState.typingUsers[chatId] = false;
        const responses = [
          "Thanks for your message! I'll get back to you soon.",
          "That sounds great! Let me check on that for you.",
          "I appreciate you reaching out. Let's discuss this further.",
          "Perfect! I'll have more details for you shortly.",
          "Got it! I'll look into this and respond soon."
        ];
        const r = responses[Math.floor(Math.random() * responses.length)];
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const m = { id: Date.now()+1, text: r, sender:'them', time, timestamp:new Date(), status:'delivered' };
        chatState.openChatWindows = chatState.openChatWindows.map(c => c.id === chatId ? { ...c, messages:[...c.messages, m] } : c);
        chatState.conversations = chatState.conversations.map(conv => conv.id === chatId ? { ...conv, lastMessage: r, time:'Now', messages:[...conv.messages, m] } : conv);
        renderFloatingChats();
        setTimeout(() => autoScrollMessages(chatId), 100);
      }, Math.random()*2000 + 1500);
    }

    function renderFloatingChats(){
      const root = document.getElementById('floating-chats-root');
      if(!root) return;
      root.innerHTML = '';
      chatState.openChatWindows.forEach((chat, index) => {
        const container = document.createElement('div');
        container.className = `chat-window ${chat.isMinimized ? 'minimized' : ''}`;
        container.style.bottom = '0px';
        container.style.right = `${320 + (index * 280)}px`;
        container.innerHTML = `
          <div class="chat-window-header">
            <div class="chat-window-user">
              <img src="${chat.avatar}" alt="${chat.name}" class="chat-window-avatar" />
              <span class="chat-window-name">${chat.name}</span>
            </div>
            <div class="chat-window-controls">
              <i class="material-symbols-outlined chat-minimize">${chat.isMinimized ? 'expand_more' : 'expand_less'}</i>
              <i class="material-symbols-outlined chat-close">close</i>
            </div>
          </div>
          ${chat.isMinimized ? '' : `
          <div class="chat-window-messages" id="messages-${chat.id}">
            ${chat.messages.length === 0 ? `
              <div class="chat-empty-state">
                <h4>ðŸ‘‹ Hey there!</h4>
                <p>Start a conversation with ${chat.name}</p>
              </div>
            ` : `
              ${chat.messages.map(m => `
                <div class="chat-message ${m.sender === 'me' ? 'sent' : 'received'}">
                  <div class="message-content">${m.text}</div>
                  <div class="message-time">${m.time}</div>
                  ${m.sender === 'me' ? `<div class="message-status">${m.status === 'sent' ? 'âœ“' : (m.status === 'delivered' ? 'âœ“âœ“' : '')}</div>` : ''}
                </div>
              `).join('')}
              ${chatState.typingUsers[chat.id] ? `
                <div class="typing-indicator">
                  <img src="${chat.avatar}" alt="${chat.name}" class="typing-avatar" />
                  <div class="typing-bubble">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                  </div>
                </div>
              ` : ''}
            `}
          </div>
          <div class="chat-window-input">
            <input type="text" placeholder="Message ${chat.name}..." value="${chatState.messageInputs[chat.id] || ''}" />
            <button ${!(chatState.messageInputs[chat.id] || '').trim() ? 'disabled' : ''}>
              <i class="material-symbols-outlined">send</i>
            </button>
          </div>`}
        `;
        container.querySelector('.chat-window-header').addEventListener('click', () => minimizeChatWindow(chat.id));
        container.querySelector('.chat-close').addEventListener('click', (e) => { e.stopPropagation(); closeChatWindow(chat.id); });
        if (!chat.isMinimized) {
          const input = container.querySelector('.chat-window-input input');
          const button = container.querySelector('.chat-window-input button');
          input.addEventListener('input', (e) => { chatState.messageInputs[chat.id] = e.target.value; });
          input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(chat.id, input.value); } });
          button.addEventListener('click', () => sendMessage(chat.id, input.value));
        }
        const rootAppend = root;
        rootAppend.appendChild(container);
      });
    }

    // Toggle chat container and outside click
    if (chatIcon && chatContainer) {
      chatIcon.addEventListener('click', (e) => {
        const rect = chatIcon.getBoundingClientRect();
        chatContainer.style.top = (rect.bottom + 5) + 'px';
        chatContainer.style.right = (window.innerWidth - rect.right - 190) + 'px';
        chatContainer.classList.toggle('visible');
        if (notificationContainer) notificationContainer.classList.remove('visible');
        e.stopPropagation();
      });
      document.addEventListener('click', (e) => {
        if (chatContainer.classList.contains('visible') && !chatContainer.contains(e.target) && e.target !== chatIcon) {
          chatContainer.classList.remove('visible');
        }
      });
      if (closeChat) closeChat.addEventListener('click', () => chatContainer.classList.remove('visible'));
    }

    // Initial chat UI render
    renderActiveUsers();
    renderChatList();

    // ===== Profile sidebar navigation (aligned with homemain.html) =====
    const profileLink = $('#profile-link');
    if (profileLink) profileLink.addEventListener('click', () => { window.location.href = 'profile.html'; });
    $$('.profile-menu li').forEach(li => li.addEventListener('click', () => {
      const href = li.getAttribute('data-href');
      if (href) window.location.href = href;
    }));
    const logoutBtn = $('#logout-btn');
    if (logoutBtn) logoutBtn.addEventListener('click', () => { window.location.href = 'homemain.html'; });
  })();
  </script>
</body>
</html>
