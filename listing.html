<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriLink - Listings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <style>
    /* ===== GLOBAL STYLES AND VARIABLES ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; }
    :root { --brand:#047857; --brand-light:#059669; --brand-dark:#065f46; --bg:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 50%,#f0f2f5 100%); --surface:#ffffff; --surface-2:#f8fafc; --surface-hover:#f1f5f9; --text:#0f172a; --text-muted:#64748b; --text-light:#94a3b8; --border:#e2e8f0; --border-light:#f1f5f9; --ring:rgba(4,120,87,.12); --shadow-sm:0 1px 2px rgba(0,0,0,.05); --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06); --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); --radius:12px; --radius-sm:8px; }
    body { background: var(--bg); color: var(--text); line-height: 1.6; overflow-x: hidden; min-height: 100vh; }

    /* ===== HEADER CONTAINER STYLES ===== */
    .header-container { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: #FF9100; display: flex; align-items: center; padding: 0 20px; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header-left { flex: 1; display: flex; align-items: center; gap: 20px; }
    .header-center { flex: 2; display: flex; justify-content: center; align-items: center; }
    .header-right { flex: 1; display: flex; justify-content: flex-end; align-items: center; }
    .logo { font-size: 24px; font-weight: bold; color: white; }
    .search-container { display: flex; align-items: center; background-color: rgba(255,255,255,0.2); border-radius: 12px; padding: 8px 16px; gap: 12px; transition: all 0.2s ease; }
    .search-container:hover { background-color: rgba(255,255,255,0.25); }
    .search-container input { background: transparent; border: none; color: white; outline: none; width: 250px; font-size: 14px; }
    .search-container input::placeholder { color: rgba(255,255,255,0.7); }
    .search-container .material-symbols-outlined { color: white; font-size: 24px; transition: transform 0.2s ease; }
    .search-container:hover .material-symbols-outlined { transform: scale(1.1); }

    /* ===== NAV ICONS ===== */
    .material-symbols-outlined { font-family: 'Material Symbols Outlined'; }
    .nav-icons { display: flex; gap: 20px; }
    .nav-icons .icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255,255,255,0.2); display: flex; justify-content: center; align-items: center; color: white; cursor: pointer; transition: background-color 0.3s; text-decoration: none; }
    .nav-icons .icon:hover { background-color: rgba(255,255,255,0.3); }
    .nav-icons .icon .material-symbols-outlined { font-size: 24px; font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }

    /* ===== PROFILE CONTAINER SIDEBAR ===== */
    .profile-container { position: fixed; left: 0; top: 60px; bottom: 0; width: 280px; background-color: white; padding: 20px; overflow-y: auto; z-index: 90; box-shadow: 1px 0 5px rgba(0,0,0,0.1); }
    .profile-header { display: flex; align-items: center; margin-bottom: 20px; }
    .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 10px; cursor: pointer; }
    .profile-name { font-weight: 600; }
    .profile-menu { list-style: none; }
    .profile-menu li { padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; cursor: pointer; }
    .profile-menu li:hover { background-color: #f0f2f5; }
    .profile-menu li i { margin-right: 10px; color: #FF9100; }
    .logout-btn { margin-top: 20px; padding: 10px 15px; background-color: #ef4444; color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; width: 100%; }
    .logout-btn i { margin-right: 8px; }

    /* ===== MAIN CONTAINER ===== */
    .main-container { display: flex; margin-top: 0px; padding-top: 38px; min-height: 100vh; }
    .main-content { flex: 1; margin-left: 300px; margin-right: 20px; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
    .container { width: 100%; }
    header { text-align: center; margin-bottom: 30px; }
    h1 { color: #2c6b4a; }

    /* ===== FORM ===== */
    .form-container { background-color: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow-md); margin-bottom: 30px; }
    .form-group { margin-bottom: 15px; }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button.primary { background-color: #047857; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
    button.primary:hover { background-color: #065f46; }

    /* ===== LISTINGS GRID ===== */
    .main-listings-container { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 25px; margin-top: 30px; }
    .listing-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .listing-card:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .listing-header { background-color: #047857; color: white; padding: 20px; text-align: center; }
    .listing-title { margin: 0; font-size: 22px; font-weight: 600; }
    .listing-subtitle { font-size: 16px; opacity: 0.9; margin-top: 5px; }
    .listing-photo { max-width: 100%; height: 200px; object-fit: cover; width: 100%; border-radius: 8px 8px 0 0; }
    .listing-content { padding: 25px; flex: 1; }
    .listing-details { margin-bottom: 20px; }
    .detail-item { display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .detail-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .detail-label { font-weight: 600; color: #555; min-width: 140px; display: inline-block; }
    .detail-value { flex: 1; color: #333; }
    .price-tag { background-color: #047857; color: white; padding: 5px 12px; border-radius: 20px; font-weight: 600; display: inline-block; margin-top: 10px; }
    .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .edit-btn { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; background-color: #ffc107; color: #000; border: none; }
    .edit-btn:hover { background-color: #e0a800; }
    .delete-btn { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; background-color: #dc3545; color: white; border: none; }
    .delete-btn:hover { background-color: #c82333; }
    .edit-form { background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; }

    /* ===== NOTIFICATIONS & CHAT PANELS ===== */
    .notification { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .notification.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .notification.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .chat-container { position: fixed; right: 0; top: 60px; bottom: 0; width: 300px; background-color: white; padding: 15px; overflow-y: auto; z-index: 90; box-shadow: -1px 0 5px rgba(0,0,0,0.1); }
    .chat-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .active-users { margin-bottom: 20px; }
    .active-title { font-weight: 600; margin-bottom: 10px; color: #047857; }
    .active-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
    .active-user { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .user-status { position: relative; display: inline-block; }
    .user-status .status-indicator { position: absolute; bottom: 5px; right: 0; width: 10px; height: 10px; background-color: #4CAF50; border-radius: 50%; border: 2px solid white; }
    .active-user img { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 5px; }
    .conversations-title { font-weight: 600; margin: 15px 0; color: #047857; }
    .conversation { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; }
    .conversation:hover { background-color: #f0f2f5; }
    .conversation img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .conversation-info { flex: 1; }
    .conversation-name { font-weight: 600; font-size: 14px; }
    .conversation-preview { font-size: 12px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .conversation-time { font-size: 10px; color: #999; }

    .notification-container { position: fixed; width: 350px; background-color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; display: none; transition: opacity 0.2s ease; }
    .notification-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
    .notification-header h3 { margin: 0; font-size: 18px; color: #333; }
    #close-notification { cursor: pointer; color: #999; }
    #close-notification:hover { color: #333; }
    .notification-list { max-height: 400px; overflow-y: auto; }
    .notification-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; }
    .notification-item:hover { background-color: #f5f5f5; }
    .notification-content { display: flex; flex-direction: column; }
    .notification-text { font-size: 14px; color: #333; margin-bottom: 5px; }
    .notification-text strong { color: #047857; }
    .notification-time { font-size: 12px; color: #999; }
    .notification-container.visible { display: block; }
    .notification-list::-webkit-scrollbar { width: 6px; }
    .notification-list::-webkit-scrollbar-track { background: #f1f1f1; }
    .notification-list::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .notification-list::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

    .header-chat-container { position: fixed; width: 320px; background-color: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); z-index: 100; display: none; transition: all 0.3s ease; max-height: 450px; border: 1px solid #e4e6ea; }
    .header-chat-container.visible { display: block; opacity: 1; transform: translateY(0); }
    .chat-header-popup { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e4e6ea; background-color: #f8f9fa; border-radius: 12px 12px 0 0; }
    .chat-header-popup h3 { margin: 0; font-size: 18px; color: #1c1e21; font-weight: 700; }
    #close-chat { cursor: pointer; color: #8a8d91; font-size: 20px; padding: 4px; border-radius: 50%; transition: all 0.2s ease; }
    #close-chat:hover { color: #1c1e21; background-color: #e4e6ea; }
    .active-users-popup { padding: 16px 20px 12px; border-bottom: 1px solid #e4e6ea; }
    .active-title-popup { font-weight: 600; font-size: 14px; color: #047857; margin-bottom: 12px; }
    .active-list-popup { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
    .active-user-popup { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 60px; }
    .user-status-popup { position: relative; display: inline-block; margin-bottom: 6px; }
    .user-status-popup img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e4e6ea; transition: transform 0.2s ease; }
    .active-user-popup:hover .user-status-popup img { transform: scale(1.05); border-color: #047857; }
    .status-indicator-popup { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background-color: #42b883; border-radius: 50%; border: 2px solid white; }
    .name-popup { font-size: 12px; color: #65676b; text-align: center; max-width: 50px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conversations-title-popup { font-weight: 600; font-size: 14px; color: #047857; padding: 12px 20px 8px; }
    .chat-list-popup { max-height: 280px; overflow-y: auto; }
    .chat-item-popup { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; transition: background-color 0.2s; position: relative; }
    .chat-item-popup:hover { background-color: #f2f3f5; }
    .chat-item-popup img { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
    .chat-info-popup { flex: 1; min-width: 0; }
    .chat-name-popup { font-weight: 600; font-size: 14px; margin-bottom: 2px; color: #1c1e21; }
    .chat-preview-popup { font-size: 13px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-time-popup { font-size: 12px; color: #8a8d91; position: absolute; top: 12px; right: 20px; }
    .chat-list-popup::-webkit-scrollbar { width: 6px; }
    .chat-list-popup::-webkit-scrollbar-track { background: transparent; }
    .chat-list-popup::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 3px; }
    .chat-list-popup::-webkit-scrollbar-thumb:hover { background: #8a8d91; }

    /* ===== FLOATING CHAT WINDOWS ===== */
    .chat-window { position: fixed; width: 280px; height: 420px; background: white; border-radius: 12px 12px 0 0; box-shadow: 0 -4px 25px rgba(0,0,0,0.2); z-index: 1000; border: 1px solid #e4e6ea; border-bottom: none; transition: all 0.3s ease; }
    .chat-window.minimized { height: 42px; }
    .chat-window-header { background: linear-gradient(135deg, #047857 0%, #059669 100%); color: white; padding: 14px 18px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(4,120,87,0.3); }
    .chat-window-user { display: flex; align-items: center; gap: 10px; }
    .chat-window-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); }
    .chat-window-name { font-weight: 600; font-size: 15px; }
    .chat-window-controls { display: flex; gap: 6px; }
    .chat-minimize, .chat-close { font-size: 20px; cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
    .chat-minimize:hover, .chat-close:hover { background-color: rgba(255,255,255,0.2); transform: scale(1.1); }
    .chat-window-messages { height: 320px; overflow-y: auto; padding: 16px; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%); scroll-behavior: smooth; }
    .chat-empty-state { text-align: center; color: #65676b; padding: 60px 20px; }
    .chat-empty-state h4 { margin: 0 0 8px 0; color: #047857; font-size: 16px; }
    .chat-empty-state p { margin: 0; font-size: 14px; }
    .chat-message { margin-bottom: 16px; animation: messageSlideIn 0.3s ease-out; }
    .chat-message.sent { text-align: right; }
    .chat-message.received { text-align: left; }
    .message-content { display: inline-block; max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
    .chat-message.sent .message-content { background: linear-gradient(135deg, #047857 0%, #059669 100%); color: white; box-shadow: 0 2px 8px rgba(4,120,87,0.3); }
    .chat-message.received .message-content { background: #e4e6ea; color: #1c1e21; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .message-time { font-size: 11px; color: #65676b; margin-top: 6px; }
    .message-status { font-size: 10px; color: #65676b; margin-top: 4px; }
    .chat-message.sent .message-status { text-align: right; }

    @keyframes messageSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 992px) { .profile-container { transform: translateX(-100%); transition: transform 0.3s ease; } .profile-container.active { transform: translateX(0); } .main-content { margin-left: 0; margin-right: 0; } }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <div class="header-container">
    <div class="header-left">
      <div class="logo">AgriLink</div>
      <div class="search-container">
        <span class="material-symbols-outlined">search</span>
        <input type="text" placeholder="Search Agri" />
      </div>
    </div>
    <div class="header-center">
      <div class="nav-icons">
        <a href="homemain.html" class="icon"><span class="material-symbols-outlined">home</span></a>
        <a href="listing.html" class="icon"><span class="material-symbols-outlined">storefront</span></a>
        <div class="icon" id="chat-icon"><span class="material-symbols-outlined">forum</span></div>
        <div class="icon" id="notification-icon"><span class="material-symbols-outlined">notifications</span></div>
      </div>
    </div>
    <div class="header-right"></div>
  </div>
  <!-- ===== SIDEBAR ===== -->
  <div class="profile-container">
    <div class="profile-header">
      <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0ec0940b-23d9-4b1f-8e72-2a8bd35584e4.png" alt="Farmer profile picture" class="profile-pic" id="profile-link" />
      <div class="profile-name">Juan Dela Cruz</div>
    </div>
    <ul class="profile-menu">
      <li data-href="/request"><i class="material-symbols-outlined">request_quote</i><span>Request</span></li>
      <li data-href="/historyandtransaction"><i class="material-symbols-outlined">receipt_long</i><span>History and Transactions</span></li>
      <li data-href="/settings"><i class="material-symbols-outlined">privacy_tip</i><span>Settings and Privacy</span></li>
      <li data-href="/report"><i class="material-symbols-outlined">analytics</i><span>Reports</span></li>
    </ul>
    <button class="logout-btn" id="logout-btn"><i class="material-symbols-outlined">logout</i><span>Logout</span></button>
  </div>
  <!-- ===== MAIN ===== -->
  <div class="main-container">
    <div class="main-content">
      <div class="container">
        <header>
          <h1>Livestock Waste Listings</h1>
        </header>

        <div id="form-notification"></div>

        <form id="listing-form" class="form-container">
          <div class="form-row">
            <div class="form-group">
              <label for="wasteType">Waste Type *</label>
              <select id="wasteType" name="wasteType" required>
                <option value="">Select type</option>
                <option value="manure">Manure</option>
                <option value="bedding">Bedding</option>
                <option value="slurry">Slurry</option>
                <option value="compost">Compost</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="animalType">Animal Type (for Manure)</label>
              <input type="text" id="animalType" name="animalType" placeholder="e.g., Cattle" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="weight">Weight (kg) *</label>
              <input type="number" id="weight" name="weight" placeholder="e.g., 500" required />
            </div>
            <div class="form-group">
              <label for="collectionDate">Collection Date *</label>
              <input type="date" id="collectionDate" name="collectionDate" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price">Price (â‚±)</label>
              <input type="number" step="0.01" id="price" name="price" placeholder="e.g., 75.00" />
            </div>
            <div class="form-group">
              <label for="photo">Photo</label>
              <input type="file" id="photo" name="photo" accept="image/*" />
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3" placeholder="Describe the listing"></textarea>
          </div>

          <button type="submit" class="primary">Add Listing</button>
        </form>

        <div id="listings-grid" class="main-listings-container"></div>
      </div>
    </div>
  </div>
  <!-- ===== NOTIFICATION POPUP ===== -->
  <div class="notification-container" id="notification-container" style="position:fixed; top:0; right:0">
    <div class="notification-header"><h3>Notifications</h3><i class="material-symbols-outlined" id="close-notification">close</i></div>
    <div class="notification-list">
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Maria Santos</strong> commented on your listing.</div><div class="notification-time">2 hrs ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Pedro Bautista</strong> liked your compost listing.</div><div class="notification-time">5 hrs ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>AgriTech PH</strong> shared a new article: "Benefits of Organic Waste in Farming"</div><div class="notification-time">1 day ago</div></div></div>
      <div class="notification-item"><div class="notification-content"><div class="notification-text"><strong>Farmers Cooperative</strong> added a new listing for compost materials.</div><div class="notification-time">2 days ago</div></div></div>
    </div>
  </div>
  <!-- ===== CHAT POPUP ===== -->
  <div class="header-chat-container" id="header-chat-container" style="position:fixed; top:0; right:0">
    <div class="chat-header-popup">
      <h3>Chats</h3>
      <i class="material-symbols-outlined" id="close-chat">close</i>
    </div>
    <div class="active-users-popup">
      <div class="active-title-popup">Active Now</div>
      <div class="active-list-popup">
        <div class="active-user-popup" data-user='{"id":"ana-gonzales","name":"Ana Gonzales","avatar":"https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ee4b5487-b1ea-40b6-9a76-0415e304de49.png"}'>
          <div class="user-status-popup">
            <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ee4b5487-b1ea-40b6-9a76-0415e304de49.png" alt="Ana Gonzales" />
            <span class="status-indicator-popup"></span>
          </div>
          <span class="name-popup">Ana</span>
        </div>
        <div class="active-user-popup" data-user='{"id":"carlos-reyes","name":"Carlos Reyes","avatar":"https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/331059ac-f6bf-4684-b902-d37824bad8f5.png"}'>
          <div class="user-status-popup">
            <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/331059ac-f6bf-4684-b902-d37824bad8f5.png" alt="Carlos Reyes" />
            <span class="status-indicator-popup"></span>
          </div>
          <span class="name-popup">Carlos</span>
        </div>
        <div class="active-user-popup" data-user='{"id":"lorna-lim","name":"Lorna Lim","avatar":"https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/2ab478de-5d6d-4dce-8c67-baf47fd7ad8e.png"}'>
          <div class="user-status-popup">
            <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/2ab478de-5d6d-4dce-8c67-baf47fd7ad8e.png" alt="Lorna Lim" />
            <span class="status-indicator-popup"></span>
          </div>
          <span class="name-popup">Lorna</span>
        </div>
      </div>
    </div>
    <div class="conversations-title-popup">Conversations</div>
    <div class="chat-list-popup" id="chat-list-popup"></div>
  </div>
  <div id="floating-chats-root"></div>
  <script>
    // ===== DATA & STATE =====
    const initialListings = [
      { id: 1, wasteType: 'manure', weight: 500, collectionDate: '2023-06-15', description: 'Well-aged cattle manure, excellent for fertilizer', animalType: 'Cattle', price: 50.0, photo: null },
      { id: 2, wasteType: 'compost', weight: 300, collectionDate: '2023-06-18', description: 'Organic compost from mixed livestock waste', price: 75.0, photo: null },
    ];

    const initialConversations = [
      { id: 'mang-jose', name: 'Mang Jose', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/70ed3f6c-a0ca-4490-8b6a-eaa245dffa33.png', lastMessage: 'Hi, about the manure delivery tomorrow...', time: '2:30 PM', messages: [ { id: 1, text: 'Hi, about the manure delivery tomorrow...', sender: 'them', time: '2:30 PM' }, { id: 2, text: 'What time should I expect the delivery?', sender: 'them', time: '2:31 PM' } ] },
      { id: 'farmers-coop', name: 'Farmers Cooperative', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/250bc031-e5eb-4467-9d71-49154b992c13.png', lastMessage: 'New bulk order of organic fertilizer available', time: 'Yesterday', messages: [ { id: 1, text: 'New bulk order of organic fertilizer available', sender: 'them', time: 'Yesterday' }, { id: 2, text: 'Would you be interested in placing an order?', sender: 'them', time: 'Yesterday' } ] }
    ];

    const state = {
      listings: [...initialListings],
      openEditId: null,
      conversations: [...initialConversations],
      openChatWindows: [],
      typingUsers: {},
      messageInputs: {},
      notificationStyle: { top: 0, right: 0 },
      chatStyle: { top: 0, right: 0 },
    };

    // ===== HELPERS =====
    function $(sel, root=document){ return root.querySelector(sel); }
    function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
    function getWasteTypeLabel(type){ const map={manure:'Manure', bedding:'Bedding', slurry:'Slurry', compost:'Compost', other:'Other'}; return map[type]||type||'Unknown'; }
    function formatDate(dateString){ if(!dateString) return 'No date provided'; try{ return new Date(dateString).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});}catch(e){ return dateString; } }
    function showNotification(message, type){ const host=$('#form-notification'); host.innerHTML = `<div class="notification ${type}">${message}</div>`; setTimeout(()=>{host.innerHTML='';},5000); }

    // ===== NAV =====
    $('#profile-link').addEventListener('click', () => { window.location.href = '/profile'; });
    $all('.profile-menu li').forEach(li => li.addEventListener('click', () => { const href = li.getAttribute('data-href'); if (href) window.location.href = href; }));
    $('#logout-btn').addEventListener('click', () => { window.location.href = '/'; });

    // ===== HEADER POPUPS =====
    const notificationIcon = $('#notification-icon');
    const notificationContainer = $('#notification-container');
    const chatIcon = $('#chat-icon');
    const chatContainer = $('#header-chat-container');

    notificationIcon.addEventListener('click', (e) => {
      const rect = notificationIcon.getBoundingClientRect();
      state.notificationStyle = { top: rect.bottom + 5, right: window.innerWidth - rect.right - 190 };
      notificationContainer.style.top = state.notificationStyle.top + 'px';
      notificationContainer.style.right = state.notificationStyle.right + 'px';
      chatContainer.classList.remove('visible');
      notificationContainer.classList.toggle('visible');
      e.stopPropagation();
    });

    chatIcon.addEventListener('click', (e) => {
      const rect = chatIcon.getBoundingClientRect();
      state.chatStyle = { top: rect.bottom + 5, right: window.innerWidth - rect.right - 190 };
      chatContainer.style.top = state.chatStyle.top + 'px';
      chatContainer.style.right = state.chatStyle.right + 'px';
      notificationContainer.classList.remove('visible');
      chatContainer.classList.toggle('visible');
      e.stopPropagation();
    });

    document.addEventListener('click', (e) => {
      if (notificationContainer.classList.contains('visible') && !notificationContainer.contains(e.target) && e.target !== notificationIcon) {
        notificationContainer.classList.remove('visible');
      }
      if (chatContainer.classList.contains('visible') && !chatContainer.contains(e.target) && e.target !== chatIcon) {
        chatContainer.classList.remove('visible');
      }
    });
    $('#close-notification').addEventListener('click', () => notificationContainer.classList.remove('visible'));
    $('#close-chat').addEventListener('click', () => chatContainer.classList.remove('visible'));

    // ===== CHAT LIST RENDER =====
    function renderChatList() {
      const list = $('#chat-list-popup');
      list.innerHTML = '';
      state.conversations.forEach(conversation => {
        const item = document.createElement('div');
        item.className = 'chat-item-popup';
        item.innerHTML = `
          <img src="${conversation.avatar}" alt="${conversation.name}" />
          <div class="chat-info-popup">
            <div class="chat-name-popup">${conversation.name}</div>
            <div class="chat-preview-popup">${conversation.lastMessage}</div>
          </div>
          <div class="chat-time-popup">${conversation.time}</div>
        `;
        item.addEventListener('click', () => openChatWindow(conversation));
        list.appendChild(item);
      });
    }
    renderChatList();

    // Quick open chat from active users
    $all('.active-user-popup').forEach(el => {
      el.addEventListener('click', () => {
        const user = JSON.parse(el.getAttribute('data-user'));
        openChatWindow({ ...user, messages: [] });
        chatContainer.classList.remove('visible');
      });
    });

    // ===== FLOATING CHATS =====
    function openChatWindow(user) {
      if (state.openChatWindows.find(c => c.id === user.id)) return;
      const existingConversation = state.conversations.find(c => c.id === user.id);
      const newChat = { id:user.id, name:user.name, avatar:user.avatar, messages: existingConversation?.messages || user.messages || [], isMinimized:false };
      if (!existingConversation) {
        state.conversations = [ { id:user.id, name:user.name, avatar:user.avatar, lastMessage:'Start a conversation...', time:'Now', messages:[] }, ...state.conversations ];
        renderChatList();
      }
      state.openChatWindows.push(newChat);
      renderFloatingChats();
    }
    function closeChatWindow(chatId) { state.openChatWindows = state.openChatWindows.filter(c => c.id !== chatId); renderFloatingChats(); }
    function minimizeChatWindow(chatId) { state.openChatWindows = state.openChatWindows.map(c => c.id === chatId ? { ...c, isMinimized: !c.isMinimized } : c); renderFloatingChats(); }
    function sendMessage(chatId, message) {
      if (!message || !message.trim()) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const newMessage = { id: Date.now(), text: message, sender: 'me', time, timestamp:new Date(), status:'sent' };
      state.openChatWindows = state.openChatWindows.map(c => c.id === chatId ? { ...c, messages:[...c.messages, newMessage] } : c);
      state.conversations = state.conversations.map(conv => conv.id === chatId ? { ...conv, lastMessage: message, time:'Now', messages:[...conv.messages, newMessage] } : conv);
      state.messageInputs[chatId] = '';
      renderFloatingChats();
      simulateTypingAndResponse(chatId);
      setTimeout(()=>autoScrollMessages(chatId), 100);
    }
    function simulateTypingAndResponse(chatId){
      state.typingUsers[chatId] = true; renderFloatingChats();
      setTimeout(()=>{ state.typingUsers[chatId]=false; const responses=["Thanks for your message! I'll get back to you soon.","That sounds great! Let me check on that for you.","I appreciate you reaching out. Let's discuss this further.","Perfect! I'll have more details for you shortly.","Got it! I'll look into this and respond soon."]; const randomResponse=responses[Math.floor(Math.random()*responses.length)]; const time=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); const responseMessage={id:Date.now()+1,text:randomResponse,sender:'them',time,timestamp:new Date(),status:'delivered'}; state.openChatWindows=state.openChatWindows.map(c=>c.id===chatId?{...c,messages:[...c.messages,responseMessage]}:c); state.conversations=state.conversations.map(conv=>conv.id===chatId?{...conv,lastMessage:randomResponse,time:'Now',messages:[...conv.messages,responseMessage]}:conv); renderFloatingChats(); setTimeout(()=>autoScrollMessages(chatId),100); }, Math.random()*2000+1500);
    }
    function autoScrollMessages(chatId){ const el=document.getElementById(`messages-${chatId}`); if(el) el.scrollTop=el.scrollHeight; }
    function renderFloatingChats(){
      const root = document.getElementById('floating-chats-root'); root.innerHTML='';
      state.openChatWindows.forEach((chat, index) => {
        const container = document.createElement('div');
        container.className = `chat-window ${chat.isMinimized ? 'minimized' : ''}`; container.style.bottom='0px'; container.style.right = `${20 + (index * 300)}px`;
        container.innerHTML = `
          <div class=\"chat-window-header\">
            <div class=\"chat-window-user\">
              <img src=\"${chat.avatar}\" alt=\"${chat.name}\" class=\"chat-window-avatar\" />
              <span class=\"chat-window-name\">${chat.name}</span>
            </div>
            <div class=\"chat-window-controls\">
              <i class=\"material-symbols-outlined chat-minimize\">${chat.isMinimized ? 'expand_more' : 'expand_less'}</i>
              <i class=\"material-symbols-outlined chat-close\">close</i>
            </div>
          </div>
          ${chat.isMinimized? '' : `
          <div class=\"chat-window-messages\" id=\"messages-${chat.id}\">
            ${chat.messages.length === 0 ? `
              <div class=\"chat-empty-state\">
                <h4>ðŸ‘‹ Hey there!</h4>
                <p>Start a conversation with ${chat.name}</p>
              </div>
            ` : `
              ${chat.messages.map(m => `
                <div class=\"chat-message ${m.sender === 'me' ? 'sent' : 'received'}\">
                  <div class=\"message-content\">${m.text}</div>
                  <div class=\"message-time\">${m.time}</div>
                  ${m.sender === 'me' ? `<div class=\"message-status\">${m.status === 'sent' ? 'âœ“' : (m.status === 'delivered' ? 'âœ“âœ“' : '')}</div>` : ''}
                </div>
              `).join('')}
              ${state.typingUsers[chat.id] ? `
                <div class=\"typing-indicator\">
                  <img src=\"${chat.avatar}\" alt=\"${chat.name}\" class=\"typing-avatar\" />
                  <div class=\"typing-bubble\">
                    <div class=\"typing-dot\"></div>
                    <div class=\"typing-dot\"></div>
                    <div class=\"typing-dot\"></div>
                  </div>
                </div>
              ` : ''}
            `}
          </div>
          <div class=\"chat-window-input\">
            <input type=\"text\" placeholder=\"Message ${chat.name}...\" value=\"${state.messageInputs[chat.id] || ''}\" />
            <button ${!(state.messageInputs[chat.id]||'').trim()?'disabled':''}><i class=\"material-symbols-outlined\">send</i></button>
          </div>`}
        `;
        container.querySelector('.chat-window-header').addEventListener('click', () => minimizeChatWindow(chat.id));
        container.querySelector('.chat-close').addEventListener('click', (e)=>{ e.stopPropagation(); closeChatWindow(chat.id); });
        if (!chat.isMinimized) {
          const input = container.querySelector('.chat-window-input input');
          const btn = container.querySelector('.chat-window-input button');
          input.addEventListener('input', (e)=>{ state.messageInputs[chat.id]=e.target.value; });
          input.addEventListener('keypress', (e)=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(chat.id, input.value); }});
          btn.addEventListener('click', ()=> sendMessage(chat.id, input.value));
        }
        root.appendChild(container);
      });
    }

    // ===== LISTINGS RENDER =====
    function renderListings(){
      const grid = document.getElementById('listings-grid');
      grid.innerHTML = '';
      state.listings.forEach(listing => {
        const card = document.createElement('div');
        card.className = 'listing-card';
        const title = listing.animalType ? `${listing.animalType} ${getWasteTypeLabel(listing.wasteType)}` : getWasteTypeLabel(listing.wasteType);
        card.innerHTML = `
          ${listing.photo ? `<img class=\"listing-photo\" src=\"${listing.photo}\" alt=\"${title}\" />` : ''}
          <div class=\"listing-header\">
            <h2 class=\"listing-title\">${title}</h2>
            <div class=\"listing-subtitle\">${formatDate(listing.collectionDate)}</div>
          </div>
          <div class=\"listing-content\">
            <div class=\"listing-details\">
              <div class=\"detail-item\"><span class=\"detail-label\">Waste Type:</span><span class=\"detail-value\">${getWasteTypeLabel(listing.wasteType)}</span></div>
              <div class=\"detail-item\"><span class=\"detail-label\">Weight:</span><span class=\"detail-value\">${listing.weight} kg</span></div>
              <div class=\"detail-item\"><span class=\"detail-label\">Description:</span><span class=\"detail-value\">${listing.description || 'â€”'}</span></div>
              ${listing.price!=null? `<div class=\"price-tag\">â‚±${Number(listing.price).toFixed(2)}</div>` : ''}
            </div>
            <div class=\"actions\">
              <button class=\"edit-btn\">Edit</button>
              <button class=\"delete-btn\">Delete</button>
            </div>
            <div class=\"edit-form\" style=\"display:none\"></div>
          </div>
        `;
        const editBtn = card.querySelector('.edit-btn');
        const deleteBtn = card.querySelector('.delete-btn');
        const editFormHost = card.querySelector('.edit-form');

        editBtn.addEventListener('click', ()=>{
          const open = editFormHost.style.display !== 'none';
          editFormHost.style.display = open ? 'none' : 'block';
          if (!open) {
            editFormHost.innerHTML = `
              <div class=\"form-row\">
                <div class=\"form-group\">
                  <label>Waste Type</label>
                  <select class=\"_wasteType\">
                    <option value=\"manure\" ${listing.wasteType==='manure'?'selected':''}>Manure</option>
                    <option value=\"bedding\" ${listing.wasteType==='bedding'?'selected':''}>Bedding</option>
                    <option value=\"slurry\" ${listing.wasteType==='slurry'?'selected':''}>Slurry</option>
                    <option value=\"compost\" ${listing.wasteType==='compost'?'selected':''}>Compost</option>
                    <option value=\"other\" ${listing.wasteType==='other'?'selected':''}>Other</option>
                  </select>
                </div>
                <div class=\"form-group\">
                  <label>Animal Type</label>
                  <input type=\"text\" class=\"_animalType\" value=\"${listing.animalType||''}\" />
                </div>
              </div>
              <div class=\"form-row\">
                <div class=\"form-group\">
                  <label>Weight (kg)</label>
                  <input type=\"number\" class=\"_weight\" value=\"${listing.weight}\" />
                </div>
                <div class=\"form-group\">
                  <label>Collection Date</label>
                  <input type=\"date\" class=\"_collectionDate\" value=\"${listing.collectionDate}\" />
                </div>
              </div>
              <div class=\"form-row\">
                <div class=\"form-group\">
                  <label>Price (â‚±)</label>
                  <input type=\"number\" step=\"0.01\" class=\"_price\" value=\"${listing.price??''}\" />
                </div>
                <div class=\"form-group\">
                  <label>Description</label>
                  <input type=\"text\" class=\"_description\" value=\"${listing.description||''}\" />
                </div>
              </div>
              <div style=\"display:flex; gap:10px; justify-content:flex-end;\">
                <button type=\"button\" class=\"primary _save\">Save</button>
                <button type=\"button\" class=\"_cancel\">Cancel</button>
              </div>
            `;
            editFormHost.querySelector('._cancel').addEventListener('click', ()=>{ editFormHost.style.display='none'; });
            editFormHost.querySelector('._save').addEventListener('click', ()=>{
              const draft = {
                wasteType: editFormHost.querySelector('._wasteType').value,
                animalType: editFormHost.querySelector('._animalType').value,
                weight: parseFloat(editFormHost.querySelector('._weight').value),
                collectionDate: editFormHost.querySelector('._collectionDate').value,
                price: (v=> v===''? null : parseFloat(v))(editFormHost.querySelector('._price').value),
                description: editFormHost.querySelector('._description').value,
              };
              // Basic validation
              if (!draft.wasteType || !draft.collectionDate || isNaN(draft.weight) || draft.weight<=0) { showNotification('Please provide valid values for required fields', 'error'); return; }
              state.listings = state.listings.map(l => l.id === listing.id ? { ...l, ...draft } : l);
              showNotification('Listing updated successfully!', 'success');
              renderListings();
            });
          }
        });
        deleteBtn.addEventListener('click', ()=>{
          if (!confirm('Are you sure you want to delete this listing?')) return;
          state.listings = state.listings.filter(l => l.id !== listing.id);
          showNotification('Listing deleted successfully!', 'success');
          renderListings();
        });

        grid.appendChild(card);
      });
    }

    // ===== FORM HANDLERS =====
    $('#listing-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const wasteType = $('#wasteType').value;
      const animalType = $('#animalType').value.trim();
      const weightStr = $('#weight').value;
      const collectionDate = $('#collectionDate').value;
      const priceStr = $('#price').value;
      const description = $('#description').value.trim();
      const photoInput = $('#photo');

      if (!wasteType || !weightStr || !collectionDate) { showNotification('Please fill in all required fields', 'error'); return; }
      if (wasteType === 'manure' && !animalType) { showNotification('Please enter the animal type for manure', 'error'); return; }
      const weight = parseFloat(weightStr); if (isNaN(weight) || weight <= 0) { showNotification('Please enter a valid weight greater than 0', 'error'); return; }
      let price = null; if (priceStr && priceStr.trim() !== '') { const p = parseFloat(priceStr); if (isNaN(p) || p < 0) { showNotification('Please enter a valid price (0 or greater)', 'error'); return; } price = p; }

      let photoUrl = null;
      const file = photoInput.files && photoInput.files[0];
      if (file) {
        try { photoUrl = URL.createObjectURL(file); } catch(err) { photoUrl = null; }
      }

      const newListing = { id: Date.now(), wasteType, weight, collectionDate, description, animalType, price, photo: photoUrl };
      state.listings = [...state.listings, newListing];
      showNotification('Listing added successfully!', 'success');
      // Reset form
      e.target.reset();
      renderListings();
    });

    // Initial render
    renderListings();
  </script>
</body>
</html>
